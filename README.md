# Bitbank 自動積立ツール

> **目的**: Bitbank API を用いて **BTC/ETH を週次で定額積立 (DCA)** する。  
> **特徴**: 成行発注・数量刻み丸め・安全ガード（スプレッド/短期ボラ/スリップ）・LINE通知。  
> **非目的**: 平均取得単価（口座全体）や評価額・損益の算出は **範囲外**（別ツール推奨）。

---

## 概要

- **対象ペア**: `btc_jpy` / `eth_jpy`（現状 2 通貨に固定）
- **デフォルト配分**: BTC **70%** / ETH **30%**（環境変数で変更可）
- **スケジュール**
  - **Dry-run**（通知のみ）: **毎日 09:00 JST**（GitHub Actions）
  - **Live**（実発注）: **毎週 月曜 09:00 JST**（GitHub Actions）
- **発注方式**: 成行（マーケット BUY。数量で発注）
- **認証方式**: **ACCESS-NONCE**（ミリ秒 Nonce／単調増加）
- **通知**: LINE Messaging API（1 回の実行で 1 通に集約）
- **ディップ買い増し**: 24h 騰落率が閾値以下で「割当額 × 倍率」

> **安全設計**  
> - コードに **セーフティゲート**を実装：`DCA_LIVE=1` が **設定されていない限り実発注しません**。  
> - ドライランは `--dry-run` フラグで常に発注なし。

---

## 発注ロジック

1. **価格参照 (`quote`)**  
   - 板の **最良アスク** を参照価格とし、`数量 = 割当JPY / quote` を算出
2. **丸め**  
   - 取引所の **最小数量** / **数量刻み** に沿って **下方向に丸め**
3. **ガード**（順に判定）  
   - スプレッド上限超過 → **SKIP**  
   - 直近 5 分の変化率（ボラ）上限超過 → **SKIP**  
   - 想定スリッページ超過（実発注時のみ） → **SKIP**
4. **残高チェック**  
   - 総額に不足 → **全スキップ**して通知（低残高アラートも送付）
5. **ディップ買い増し**（ON の場合）  
   - 24h 騰落率が `DIP_TRIGGER_PCT` 以下 → **割当 × `DIP_MULTIPLIER`**  
   - 片方/両方がディップでも、最小数量・刻みに満たなければ **SKIP**

---

## 用語（通知に出る値）

| 項目 | 説明 |
|---|---|
| **alloc** | 通貨ごとの割当 JPY（ディップ倍率適用後） |
| **quote** | **数量計算に使った参照価格（最良アスク）** |
| **avg** | **平均約定価格**（市場状況で `quote` と乖離し得る） |
| **ordered** | 丸め後に**発注した数量** |
| **filled** | 実際に**約定した数量** |
| **slip (%)** | `(avg / quote - 1) × 100` |
| **24h change** | 過去 24 時間の騰落率（参考値） |

---

## 環境変数

### Secrets（必須・リポジトリの **Actions > Secrets** に保存）

| 変数名 | 用途 |
|---|---|
| `BITBANK_API_KEY` | 取引用 API キー（**出金権限は付けない**） |
| `BITBANK_API_SECRET` | API シークレット |
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Messaging API のチャネルアクセストークン |
| `LINE_USER_ID` | 送信先ユーザーの User ID（プッシュ通知） |

### Variables / 環境（変更可）

> **実装で使用している主要なもの**（確実に反映されます）

| 変数名 | 例（デフォルト） | 説明 |
|---|---|---|
| `DCA_TOTAL_JPY` | `10000` | 1 回の購入総額（円） |
| `DCA_RATIO_BTC` | `0.7` | BTC の配分（0〜1） |
| `DCA_RATIO_ETH` | `0.3` | ETH の配分（0〜1） |
| `DIP_MULTIPLIER` | `1.5` | ディップ時の割当倍率 |
| `GUARD_DIP_THRESHOLD` | `-0.03` | ディップ発動条件（24h 変化率がこの値以下） |
| `LOW_BALANCE_ALERT_JPY` | `20000` | 残高警告のしきい値（円） |
| `DCA_LIVE` | `0` | **実発注ゲート**（`1/true/on/yes` で有効。未設定なら常に SKIP） |

> スプレッド/5分ボラ/スリップの上限値はコード内デフォルトを利用（必要時は実装側で調整）。

---

## 実行方法

### ローカル

- **ドライラン（発注なし）**
```bash
python3 -m app.main --dry-run
```

- **通常実行（安全に SKIP させたい）**  
  `DCA_LIVE` を設定しなければ発注されません。
```bash
python3 -m app.main   # => SKIP: LIVE_DISABLED
```

- **実発注（本当に買う）**
```bash
export DCA_LIVE=1
python3 -m app.main
unset DCA_LIVE
```

## GitHub Actions
- requirements.txt をインストールして実行（依存：requests / python-dotenv / pytz）
- Dry-run: 毎日 09:00 JST に自動実行（通知のみ）
- Live: 毎週 月曜 09:00 JST に自動実行
（workflow で DCA_LIVE: "1" を渡しておく。手動実行も可能）

いずれの Workflow も、Secrets と Variables をリポジトリに設定してから動かしてください。

---

## 比率や総額の変更
- 総額を 10,000 円 → 8,000 円に変更
```text
DCA_TOTAL_JPY=8000
```

- **配分**を BTC 60% / ETH 40% に変更
```text
DCA_RATIO_BTC=0.6
DCA_RATIO_ETH=0.4
```

> **メモ**: ETH は最小数量・刻みに満たないと **SKIP（最小数量未満）** になります。少額時にもETHを必ず買いたい場合は、配分や総額を上げるか、運用ポリシーとして「ETH最低割当（例: 常に 1,000 円以上）」を導入してください（実装は別イシューで対応可）。

---

## 安全対策まとめ
- うっかり発注防止: `DCA_LIVE` を **設定しない限り**実発注しない（`SKIP: LIVE_DISABLED`）。
- 事前確認: `--dry-run` で毎日LINE通知を確認。
- 本当に発注するときだけ:
  ```bash
  export DCA_LIVE=1
  python3 -m app.main
  unset DCA_LIVE
  ```
- GitHub Actions: Live は **毎週月曜 09:00 JST** に実行。Dry-run は毎日 09:00 JST。

---

## ライセンス / 免責
- 本ツールは投資助言を目的とするものではありません。利用は自己責任でお願いします。
- APIキーは **取引権限のみ**・**出金権限なし** で作成し、Secrets で厳重に管理してください。