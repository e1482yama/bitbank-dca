# Bitbank 自動積立ツール（README）

> **目的**: Bitbank API を用いて **BTC/ETH を週次で定額積立 (DCA)**。  
> **特徴**: 成行発注＋安全ガード（スリッページ/スプレッド/短期ボラ）＋ LINE 通知。  
> **非目的**: 平均取得単価・評価額・損益の算出は **範囲外**（別ツール推奨）。

---

## 概要

- **銘柄と配分**: `btc_jpy` **70%** / `eth_jpy` **30%**（週1、総額 10,000 円）
- **スケジュール**: 毎週 **月曜 07:00 JST**
- **発注**: 成行（マーケット BUY）
- **認証**: `ACCESS-TIME-WINDOW`
- **実行基盤**: GitHub Actions（Private Repo / Secrets 管理）
- **通知**: LINE Notify（1回の実行につき1通に集約）
- **ディップ買い増し**: 24h 下落率が閾値以下で割当額に倍率（可変）を乗算

---

## 発注ロジック（簡潔）

1. **価格参照**  
   - 板の **最良アスク** を `quote` とし、  
     `数量 = 割当JPY ÷ quote` を算出（成行は数量指定のため）
2. **丸め**  
   - 取引所の **最小数量/刻み** に合わせて **下方向丸め**
3. **ガード**  
   - スリッページ急変（±`SLIPPAGE_PCT` 超） → **スキップ**  
   - スプレッド上限（`SPREAD_MAX_PCT` 超） → **スキップ**  
   - 直近5分ボラ（±`VOL5M_MAX_PCT` 超） → **スキップ**
4. **残高チェック**  
   - 総額に不足 → **全スキップ**して通知  
   - 実行時の残高を表示し、`LOW_BALANCE_ALERT_JPY` を下回れば警告
5. **ディップ買い増し**（ON 時）  
   - 24h 騰落率が `DIP_TRIGGER_PCT` 以下 → 割当額 × `DIP_MULTIPLIER`

---

## LINE 通知（週1・セット）

```
[DCA完了] 2025-08-26 07:00 JST
総額: 10,000円  (DIP: 非発動, trigger=-3%, multiplier=1.5)
24h change: BTC -2.4%, ETH -1.1%
残高: 18,450円  [WARN] Low balance (<20,000)

BTC (70%):
  alloc=7,000円 quote=16,260,000
  ordered=0.00043 / filled=0.00043 avg=16,270,000 slip=+0.06%
  fee=0.00000043 BTC (≈7円)  status=完了

ETH (30%):
  alloc=3,000円 quote=490,000
  ordered=0.00612 / filled=0.00612 avg=492,000 slip=+0.41%
  fee=0.00000610 ETH (≈9円)  status=完了

次回: 2025-09-01 07:00
```

### 表示項目の意味

| 項目 | 説明 |
|---|---|
| **alloc** | 銘柄ごとの割当 JPY（繰越・DIP 反映後の最終額） |
| **quote** | **数量計算に使う参照価格**（原則 **最良アスク**）。`ordered = alloc / quote` |
| **ordered** | 丸め後に **発注した数量** |
| **filled** | 実際に **約定した数量** |
| **avg** | **平均約定価格**（市場状況により `quote` と乖離し得る） |
| **slip (%)** | スリッページ率 = `(avg / quote - 1) × 100` |
| **fee** | 手数料（数量単位／円換算の両方を表示） |
| **status** | 完了 / 部分約定 / 失敗 |
| **24h change** | 過去24時間の騰落率（参考情報） |

---

## 環境変数・パラメータ

### Variables（可変）

| 変数名 | デフォルト | 説明 |
|--------|------------|------|
| `TOTAL_JPY` | `10000` | 1回あたりの購入総額（円） |
| `PAIRS` | `btc_jpy,eth_jpy` | 対象の通貨ペア（カンマ区切り） |
| `WEIGHTS` | `0.7,0.3` | 各ペアの配分（`PAIRS` と同じ順序／合計=1.0） |
| `SLIPPAGE_PCT` | `0.008` | スリッページ許容（±0.8%） |
| `SPREAD_MAX_PCT` | `0.005` | スプレッド上限（0.5%） |
| `VOL5M_MAX_PCT` | `0.03` | 直近5分のボラ判定（±3%） |
| `DIP_TRIGGER_PCT` | `-0.03` | ディップ発動条件（-3%以下） |
| `DIP_MULTIPLIER` | `1.5` | ディップ時の割当倍率 |
| `LOW_BALANCE_ALERT_JPY` | `20000` | 残高が下回ったら警告 |
| `TIME_WINDOW_MS` | `5000` | 認証 Time Window（ms） |
| `AUTH_MODE` | `TIME_WINDOW` | `TIME_WINDOW` / `NONCE` |

> **ポイント**:  
> - `PAIRS` と `WEIGHTS` は **要素数・順序を一致** させる  
> - `WEIGHTS` の合計は必ず **1.0** にする

### Secrets（機密）

| Secret | 用途 |
|---|---|
| `BITBANK_API_KEY` | 取引用 API キー（**出金権限なし**で作成） |
| `BITBANK_API_SECRET` | API シークレット |
| `LINE_NOTIFY_TOKEN` | LINE Notify アクセストークン |

---

## コインの追加・削除・比率変更・総額変更

このツールは **PAIRS と WEIGHTS** に基づいて配分を決定します。  
したがってリポジトリのコードを触らず、**Variables を変更するだけ**で柔軟に対応できます。

### 例1: LINK を 5% 追加（ETH を -5%）

```
PAIRS=btc_jpy,eth_jpy,link_jpy
WEIGHTS=0.70,0.25,0.05
```

### 例2: 積立額を 10,000 円 → 8,000 円

```
TOTAL_JPY=8000
```

### 例3: コインを削除（LINK を外す）

```
PAIRS=btc_jpy,eth_jpy
WEIGHTS=0.70,0.30
```

---

## スケジュール（GitHub Actions）

- JST 07:00（月曜） = UTC `0 22 * * 0`
- `workflow_dispatch` により手動実行も可能

---

## スコープ外

- 平均取得単価（口座全体/ボット分）
- 評価額（円換算）・含み損益
- 税務レポート生成

---

## 免責

- 本ツールは投資助言を目的とするものではありません。  
- 利用は自己責任でお願いします。  
- API キーは必ず **取引権限のみ**・**出金権限なし** で作成してください。
